{% extends "base.html" %}

{% block head %}
    <title>Crave On - Orders</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/customer/orders.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap.min.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
{% endblock %}

{% block content %}
<div class="bg-container">
    <div class="col-md-8 mx-auto mt-4">
        <div class="cart-container">
            <form id="orderForm" method="POST">
                <div id="orderItemsContainer"></div>
                <div class="border-top pt-2">
                    <p class="total-amount text-start fw-bold" id="totalAmountText">Total Amount: ₱0</p>
                    <button type="button" class="btn-order w-100" id="proceedPaymentBtn">PROCEED TO PAYMENT</button>
                </div>                    
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const container = document.getElementById("orderItemsContainer");
        const totalAmountText = document.getElementById("totalAmountText");

        let cartItems = JSON.parse(sessionStorage.getItem('cart_items')) || [];

        function renderCart() {
            container.innerHTML = "";
            let total = 0;

            if (cartItems.length === 0) {
                container.innerHTML = "<p class='text-light'>Your order is empty.</p>";
                totalAmountText.textContent = `Total Amount: ₱0`;
                return;
            }

            cartItems.forEach((item, index) => {
                const subtotal = item.price * item.quantity;
                total += subtotal;

                container.innerHTML += `
                    <div class="cart-item mb-3" data-index="${index}">
                        <div class="item-info d-flex align-items-center justify-content-between">
                            <div class="d-flex align-items-center">
                                <img class="item-image me-3" src="${item.image_url}" alt="${item.name}" style="width: 60px; height: 60px;">
                                <div class="d-flex flex-column">
                                    <strong class="text-light">${item.name}</strong>
                                    <small class="text-light">₱${item.quantity} x ₱${item.price} = ₱${subtotal.toFixed(2)}</small>
                                </div>
                            </div>
                            <div class="d-flex align-items-center">
                                <button class="btn btn-sm btn-outline-light me-1 qty-btn" data-index="${index}" data-action="decrease">-</button>
                                <span class="text-light mx-2">${item.quantity}</span>
                                <button class="btn btn-sm btn-outline-light ms-1 qty-btn" data-index="${index}" data-action="increase">+</button>
                                <button class="btn btn-sm btn-danger ms-3 remove-btn" data-index="${index}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>`;
            });

            totalAmountText.textContent = `Total Amount: ₱${total.toFixed(2)}`;
            sessionStorage.setItem('cart_items', JSON.stringify(cartItems));
        }

        container.addEventListener("click", function (e) {
            if (e.target.classList.contains("qty-btn")) {
                const index = parseInt(e.target.getAttribute("data-index"));
                const action = e.target.getAttribute("data-action");

                if (action === "increase") {
                    cartItems[index].quantity += 1;
                } else if (action === "decrease" && cartItems[index].quantity > 1) {
                    cartItems[index].quantity -= 1;
                }
                renderCart();
            }

            if (e.target.classList.contains("remove-btn") || e.target.closest('.remove-btn')) {
                const button = e.target.closest('.remove-btn');
                const index = parseInt(button.getAttribute("data-index"));

                if (confirm("Are you sure you want to remove this item?")) {
                    cartItems.splice(index, 1);
                    renderCart();
                }
            }
        });

        // Initial render
        renderCart();

        // Proceed to payment
        document.getElementById('proceedPaymentBtn').addEventListener('click', function () {
            if (cartItems.length === 0) {
                alert("Order is empty!");
                return;
            }

            sessionStorage.setItem('cart_items', JSON.stringify(cartItems));
            window.location.href = "{{ url_for('customer.payment') }}";
        });
    });
</script>
{% endblock %}
